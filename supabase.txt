-- WARNING: This schema is for context only and is not meant to be run.
-- Table order and constraints may not be valid for execution.

CREATE TABLE public.activity_logs (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  company_id uuid NOT NULL,
  user_id uuid,
  entity_type text NOT NULL CHECK (entity_type = ANY (ARRAY['site'::text, 'client'::text, 'prospect'::text, 'team'::text, 'user'::text, 'company'::text])),
  entity_id uuid NOT NULL,
  action text NOT NULL CHECK (action = ANY (ARRAY['created'::text, 'updated'::text, 'deleted'::text, 'status_changed'::text, 'assigned'::text, 'completed'::text])),
  old_values jsonb,
  new_values jsonb,
  description text,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT activity_logs_pkey PRIMARY KEY (id),
  CONSTRAINT activity_logs_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.profiles(id),
  CONSTRAINT activity_logs_company_id_fkey FOREIGN KEY (company_id) REFERENCES public.companies(id)
);
CREATE TABLE public.checklist_template_items (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  template_id uuid NOT NULL,
  title text NOT NULL,
  description text,
  position integer NOT NULL,
  is_required boolean DEFAULT false,
  estimated_duration_minutes integer,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT checklist_template_items_pkey PRIMARY KEY (id),
  CONSTRAINT checklist_template_items_template_id_fkey FOREIGN KEY (template_id) REFERENCES public.checklist_templates(id)
);
CREATE TABLE public.checklist_templates (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  company_id uuid NOT NULL,
  created_by uuid,
  name text NOT NULL,
  description text,
  category text,
  is_active boolean DEFAULT true,
  is_default boolean DEFAULT false,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT checklist_templates_pkey PRIMARY KEY (id),
  CONSTRAINT checklist_templates_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.profiles(id),
  CONSTRAINT checklist_templates_company_id_fkey FOREIGN KEY (company_id) REFERENCES public.companies(id)
);
CREATE TABLE public.clients (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  company_id uuid NOT NULL,
  created_by uuid,
  name text NOT NULL,
  email text,
  phone text,
  address text,
  billing_address text,
  notes text,
  tags ARRAY,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT clients_pkey PRIMARY KEY (id),
  CONSTRAINT clients_company_id_fkey FOREIGN KEY (company_id) REFERENCES public.companies(id),
  CONSTRAINT clients_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.profiles(id)
);
CREATE TABLE public.companies (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  name text NOT NULL,
  siret text,
  address text,
  logo_url text,
  stripe_customer_id text UNIQUE,
  stripe_subscription_id text,
  subscription_status text DEFAULT 'trial'::text CHECK (subscription_status = ANY (ARRAY['active'::text, 'inactive'::text, 'trial'::text, 'canceled'::text, 'past_due'::text])),
  subscription_plan text DEFAULT 'basic'::text CHECK (subscription_plan = ANY (ARRAY['basic'::text, 'pro'::text, 'enterprise'::text])),
  trial_end_date timestamp with time zone DEFAULT (now() + '14 days'::interval),
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT companies_pkey PRIMARY KEY (id)
);
CREATE TABLE public.email_templates (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  company_id uuid NOT NULL,
  created_by uuid,
  name text NOT NULL,
  subject text NOT NULL,
  body text NOT NULL,
  available_variables ARRAY DEFAULT ARRAY['client_name'::text, 'site_name'::text, 'company_name'::text],
  category text,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT email_templates_pkey PRIMARY KEY (id),
  CONSTRAINT email_templates_company_id_fkey FOREIGN KEY (company_id) REFERENCES public.companies(id),
  CONSTRAINT email_templates_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.profiles(id)
);
CREATE TABLE public.kanban_statuses (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  company_id uuid NOT NULL,
  name text NOT NULL,
  color text NOT NULL DEFAULT '#6B7280'::text,
  position integer NOT NULL,
  is_default boolean DEFAULT false,
  is_final boolean DEFAULT false,
  is_archived boolean DEFAULT false,
  applies_to ARRAY DEFAULT ARRAY['sites'::text, 'prospects'::text],
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT kanban_statuses_pkey PRIMARY KEY (id),
  CONSTRAINT kanban_statuses_company_id_fkey FOREIGN KEY (company_id) REFERENCES public.companies(id)
);
CREATE TABLE public.profiles (
  id uuid NOT NULL,
  company_id uuid NOT NULL,
  team_id uuid,
  full_name text NOT NULL,
  email text NOT NULL,
  avatar_url text,
  phone text,
  role text NOT NULL DEFAULT 'employe'::text CHECK (role = ANY (ARRAY['admin'::text, 'chef_chantier'::text, 'employe'::text])),
  permissions jsonb DEFAULT '[]'::jsonb,
  is_active boolean DEFAULT true,
  last_login timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT profiles_pkey PRIMARY KEY (id),
  CONSTRAINT profiles_team_id_fkey FOREIGN KEY (team_id) REFERENCES public.teams(id),
  CONSTRAINT profiles_id_fkey FOREIGN KEY (id) REFERENCES auth.users(id),
  CONSTRAINT profiles_company_id_fkey FOREIGN KEY (company_id) REFERENCES public.companies(id)
);
CREATE TABLE public.prospects (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  company_id uuid NOT NULL,
  status_id uuid NOT NULL,
  assigned_to uuid,
  project_name text NOT NULL,
  contact_name text,
  email text,
  phone text,
  address text,
  estimated_amount numeric,
  probability integer DEFAULT 50 CHECK (probability >= 0 AND probability <= 100),
  expected_close_date date,
  description text,
  priority integer DEFAULT 3 CHECK (priority >= 1 AND priority <= 5),
  kanban_position integer DEFAULT 0,
  source text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT prospects_pkey PRIMARY KEY (id),
  CONSTRAINT prospects_status_id_fkey FOREIGN KEY (status_id) REFERENCES public.kanban_statuses(id),
  CONSTRAINT prospects_assigned_to_fkey FOREIGN KEY (assigned_to) REFERENCES public.profiles(id),
  CONSTRAINT prospects_company_id_fkey FOREIGN KEY (company_id) REFERENCES public.companies(id)
);
CREATE TABLE public.site_checklist_items (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  checklist_id uuid NOT NULL,
  template_item_id uuid,
  title text NOT NULL,
  description text,
  position integer NOT NULL,
  is_completed boolean DEFAULT false,
  completed_by uuid,
  completed_at timestamp with time zone,
  notes text,
  requires_photo boolean DEFAULT false,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT site_checklist_items_pkey PRIMARY KEY (id),
  CONSTRAINT site_checklist_items_completed_by_fkey FOREIGN KEY (completed_by) REFERENCES public.profiles(id),
  CONSTRAINT site_checklist_items_template_item_id_fkey FOREIGN KEY (template_item_id) REFERENCES public.checklist_template_items(id),
  CONSTRAINT site_checklist_items_checklist_id_fkey FOREIGN KEY (checklist_id) REFERENCES public.site_checklists(id)
);
CREATE TABLE public.site_checklists (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  site_id uuid NOT NULL,
  template_id uuid,
  created_by uuid,
  name text NOT NULL,
  description text,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT site_checklists_pkey PRIMARY KEY (id),
  CONSTRAINT site_checklists_template_id_fkey FOREIGN KEY (template_id) REFERENCES public.checklist_templates(id),
  CONSTRAINT site_checklists_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.profiles(id),
  CONSTRAINT site_checklists_site_id_fkey FOREIGN KEY (site_id) REFERENCES public.sites(id)
);
CREATE TABLE public.site_media (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  site_id uuid NOT NULL,
  uploaded_by uuid NOT NULL,
  checklist_item_id uuid,
  file_path text NOT NULL,
  file_type text NOT NULL CHECK (file_type = ANY (ARRAY['image'::text, 'document'::text, 'video'::text])),
  mime_type text,
  file_size integer,
  original_filename text,
  title text,
  description text,
  tags ARRAY,
  is_public boolean DEFAULT false,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT site_media_pkey PRIMARY KEY (id),
  CONSTRAINT site_media_site_id_fkey FOREIGN KEY (site_id) REFERENCES public.sites(id),
  CONSTRAINT site_media_checklist_item_id_fkey FOREIGN KEY (checklist_item_id) REFERENCES public.site_checklist_items(id),
  CONSTRAINT site_media_uploaded_by_fkey FOREIGN KEY (uploaded_by) REFERENCES public.profiles(id)
);
CREATE TABLE public.sites (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  company_id uuid NOT NULL,
  client_id uuid NOT NULL,
  team_id uuid,
  status_id uuid NOT NULL,
  assigned_to uuid,
  name text NOT NULL,
  description text,
  address text,
  latitude double precision,
  longitude double precision,
  start_date date NOT NULL,
  end_date date NOT NULL,
  start_time time without time zone,
  end_time time without time zone,
  estimated_amount numeric,
  final_amount numeric,
  currency text DEFAULT 'EUR'::text,
  priority integer DEFAULT 3 CHECK (priority >= 1 AND priority <= 5),
  kanban_position integer DEFAULT 0,
  internal_notes text,
  client_notes text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT sites_pkey PRIMARY KEY (id),
  CONSTRAINT sites_status_id_fkey FOREIGN KEY (status_id) REFERENCES public.kanban_statuses(id),
  CONSTRAINT sites_company_id_fkey FOREIGN KEY (company_id) REFERENCES public.companies(id),
  CONSTRAINT sites_assigned_to_fkey FOREIGN KEY (assigned_to) REFERENCES public.profiles(id),
  CONSTRAINT sites_client_id_fkey FOREIGN KEY (client_id) REFERENCES public.clients(id),
  CONSTRAINT sites_team_id_fkey FOREIGN KEY (team_id) REFERENCES public.teams(id)
);
CREATE TABLE public.stripe_webhooks (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  stripe_event_id text NOT NULL UNIQUE,
  event_type text NOT NULL,
  processed boolean DEFAULT false,
  processed_at timestamp with time zone,
  error_message text,
  company_id uuid,
  data jsonb NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT stripe_webhooks_pkey PRIMARY KEY (id),
  CONSTRAINT stripe_webhooks_company_id_fkey FOREIGN KEY (company_id) REFERENCES public.companies(id)
);
CREATE TABLE public.teams (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  company_id uuid NOT NULL,
  name text NOT NULL,
  description text,
  color text DEFAULT '#3B82F6'::text,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  leader_id uuid,
  CONSTRAINT teams_pkey PRIMARY KEY (id),
  CONSTRAINT teams_company_id_fkey FOREIGN KEY (company_id) REFERENCES public.companies(id),
  CONSTRAINT teams_leader_id_fkey FOREIGN KEY (leader_id) REFERENCES public.profiles(id)
);
CREATE TABLE public.todos (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  company_id uuid NOT NULL,
  user_id uuid NOT NULL,
  site_id uuid,
  title text NOT NULL,
  description text,
  is_completed boolean DEFAULT false,
  priority integer DEFAULT 3 CHECK (priority >= 1 AND priority <= 5),
  due_date date,
  reminder_date timestamp with time zone,
  completed_at timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT todos_pkey PRIMARY KEY (id),
  CONSTRAINT todos_company_id_fkey FOREIGN KEY (company_id) REFERENCES public.companies(id),
  CONSTRAINT todos_site_id_fkey FOREIGN KEY (site_id) REFERENCES public.sites(id),
  CONSTRAINT todos_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.profiles(id)
);
CREATE TABLE public.user_invitations (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  email text NOT NULL,
  role text NOT NULL,
  team_id uuid,
  company_id uuid NOT NULL,
  invited_by uuid NOT NULL,
  status text NOT NULL DEFAULT 'pending'::text,
  expires_at timestamp with time zone NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_invitations_pkey PRIMARY KEY (id),
  CONSTRAINT user_invitations_team_id_fkey FOREIGN KEY (team_id) REFERENCES public.teams(id),
  CONSTRAINT user_invitations_company_id_fkey FOREIGN KEY (company_id) REFERENCES public.companies(id),
  CONSTRAINT user_invitations_invited_by_fkey FOREIGN KEY (invited_by) REFERENCES public.profiles(id)
);